<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Halomeny — планирование 3D-печати</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <header class="app-header">
    <div class="app-header__row">
      <div class="brand">
        <div class="brand__icon"><img src="assets/logo.svg" alt=""></div>
        <div>
          <h1>Halomeny</h1>
          <p>Система рекомендаций загрузки производственного оборудования</p>
        </div>
      </div>
      <div class="header-status">
        <span id="api-status" class="pill">API: неизвестно</span>
        <div class="dev-tools" id="dev-tools">
          <button class="icon-button icon-button--outline" id="seed-db" type="button" title="Добавить тестовые данные">
            +
          </button>
          <button
            class="icon-button icon-button--outline icon-button--danger"
            id="clear-db"
            type="button"
            title="Очистить базу данных"
          >
            −
          </button>
        </div>
        <div class="user-bar">
          <span id="user-greeting" class="muted">Гость</span>
          <button class="button button--ghost" id="auth-action" type="button">Войти</button>
        </div>
      </div>
    </div>
    <div class="app-header__row app-header__row--nav">
      <nav class="nav">
        <button class="nav__link is-active" data-page="home">Главная</button>
        <button class="nav__link" data-page="tasks">Задания</button>
        <button class="nav__link" data-page="equipment">Оборудование</button>
        <button class="nav__link" data-page="operators">Операторы</button>
        <button class="nav__link" data-page="schedules">Графики работы</button>
        <button class="nav__link" data-page="references">Справочники</button>
        <button class="nav__link" data-page="about">О нас</button>
      </nav>
      <div class="workspace-bar">
        <label for="workspace-select">Рабочее пространство</label>
        <div class="workspace-bar__controls">
          <select id="workspace-select"></select>
          <button class="button button--ghost" id="refresh-workspaces">Обновить</button>
          <button class="button" id="open-workspace-modal">Создать</button>
        </div>
      </div>
    </div>
  </header>

  <main>
    <section class="page is-active" data-page="home">
      <div class="layout-grid">
        <div class="card">
          <div class="card__header">
            <h2>Статистика на сегодня</h2>
            <button class="button button--ghost" id="recompute-plan">Пересчитать план</button>
          </div>
          <div class="stats" id="home-stats"></div>
          <div class="muted">
            <p><strong>Как работает «Пересчитать план»:</strong></p>
            <ul>
              <li>Берёт задачи без расписания и сортирует по дедлайну, затем по приоритету.</li>
              <li>Учитывает занятость принтеров и операторов, а также рабочие часы (09:00–22:00).</li>
              <li>Для каждой задачи ищет ближайший свободный слот с учётом длительности, настройки и снятия.</li>
            </ul>
          </div>
        </div>
        <div class="card">
          <div class="card__header">
            <h2>Ближайшие задачи</h2>
          </div>
          <div class="table" id="upcoming-tasks"></div>
        </div>
        <div class="card">
          <div class="card__header">
            <h2>Сущности рабочего пространства</h2>
          </div>
          <p class="card__subtitle">
            Быстрый обзор ключевых таблиц: оборудование, операторы, задания и справочники.
          </p>
          <div class="entity-summary" id="entity-summary"></div>
        </div>
      </div>

      <section class="card">
        <div class="card__header">
          <h2>Задания в течение дня</h2>
          <div class="toolbar">
            <span class="muted" id="home-date"></span>
          </div>
        </div>
        <div class="gantt" id="home-gantt"></div>
        <div class="legend legend--interactive" id="home-gantt-legend">
          <div class="legend__item" data-status="done">
            <span class="legend__swatch done"></span>Задание выполнено
          </div>
          <div class="legend__item" data-status="progress">
            <span class="legend__swatch progress"></span>Выполняется
          </div>
          <div class="legend__item" data-status="pending">
            <span class="legend__swatch pending"></span>Ожидает запуск
          </div>
        </div>
      </section>

      <section class="card">
        <div class="card__header">
          <h2>Загруженность оборудования</h2>
          <button class="button button--ghost" id="refresh-devices">Обновить</button>
        </div>
        <div class="device-grid" id="equipment-cards"></div>
      </section>
    </section>

    <section class="page" data-page="tasks">
      <div class="card">
        <div class="card__header">
          <h2>Задания</h2>
          <div class="toolbar">
            <label class="toolbar__item" for="tasks-date">
              На дату:
              <input id="tasks-date" type="date" />
            </label>
            <label class="toolbar__item" for="tasks-sort">
              Сортировать по:
              <select id="tasks-sort">
                <option value="task">Цели (названию)</option>
                <option value="device">Оборудованию</option>
              </select>
            </label>
            <button class="button" id="open-task-modal">Добавить</button>
          </div>
        </div>
        <div class="gantt" id="tasks-gantt"></div>
        <div class="legend legend--interactive" id="tasks-gantt-legend">
          <div class="legend__item" data-status="done">
            <span class="legend__swatch done"></span>Задание выполнено
          </div>
          <div class="legend__item" data-status="progress">
            <span class="legend__swatch progress"></span>Выполняется
          </div>
          <div class="legend__item" data-status="pending">
            <span class="legend__swatch pending"></span>Ожидает запуск
          </div>
        </div>
      </div>
    </section>

    <section class="page" data-page="equipment">
      <div class="card">
        <div class="card__header">
          <h2>Оборудование</h2>
          <button class="button" id="open-device-modal">Добавить</button>
        </div>
        <div class="device-grid" id="equipment-list"></div>
      </div>
    </section>

    <section class="page" data-page="operators">
      <div class="card">
        <div class="card__header">
          <h2>Операторы</h2>
          <button class="button" id="open-operator-modal">Добавить</button>
        </div>
        <div class="operators" id="operators-list"></div>
      </div>
    </section>

    <section class="page" data-page="schedules">
      <div class="card">
        <div class="card__header">
          <h2>Графики работы</h2>
          <button class="button" id="open-schedule-modal">Добавить перерыв</button>
        </div>
        <div class="gantt" id="operators-gantt"></div>
        <div class="legend legend--interactive" id="operators-gantt-legend">
          <div class="legend__item" data-status="progress">
            <span class="legend__swatch progress"></span>Печать в работе
          </div>
          <div class="legend__item" data-status="pending">
            <span class="legend__swatch pending"></span>Задание в очереди
          </div>
          <div class="legend__item" data-status="done">
            <span class="legend__swatch done"></span>Завершённая печать
          </div>
          <div class="legend__item" data-status="lunch">
            <span class="legend__swatch lunch"></span>Обед
          </div>
          <div class="legend__item" data-status="off">
            <span class="legend__swatch off"></span>Не работает
          </div>
        </div>
      </div>
    </section>

    <section class="page" data-page="references">
      <div class="layout-grid">
        <div class="card">
          <div class="card__header">
            <h2>Характеристики оборудования</h2>
          </div>
          <p class="card__subtitle">Характеристики связываются с оборудованием в рабочем пространстве.</p>
          <form class="inline-form" id="equipment-characteristic-form">
            <label>
              Название
              <input name="name" type="text" required />
            </label>
            <button class="button" type="submit">Добавить</button>
          </form>
          <div class="table table--wide" id="equipment-characteristics-list"></div>
        </div>
        <div class="card">
          <div class="card__header">
            <h2>Оборудование</h2>
          </div>
          <p class="card__subtitle">Описание типов оборудования и связанной с ними характеристики.</p>
          <form class="inline-form" id="device-type-form">
            <label>
              Название
              <input name="name" type="text" required />
            </label>
            <label>
              Характеристика
              <select name="equipment_characteristic_id" id="equipment-characteristic-select" required></select>
            </label>
            <button class="button" type="submit">Добавить</button>
          </form>
          <div class="table table--wide" id="device-types-list"></div>
        </div>
        <div class="card">
          <div class="card__header">
            <h2>Типы заданий</h2>
          </div>
          <p class="card__subtitle">Типы используются при создании производственных заданий.</p>
          <form class="inline-form" id="task-type-form">
            <label>
              Название
              <input name="name" type="text" required />
            </label>
            <button class="button" type="submit">Добавить</button>
          </form>
          <div class="table table--wide" id="task-types-list"></div>
        </div>
        <div class="card">
          <div class="card__header">
            <h2>Карта связей данных</h2>
          </div>
          <ul class="data-map">
            <li><strong>Workspace</strong> → характеристики → оборудование → устройства → задания.</li>
            <li><strong>Операторы</strong> → компетенции по оборудованию → задачи и смены.</li>
            <li><strong>Приоритеты</strong> и <strong>типы заданий</strong> задают правила планирования.</li>
            <li><strong>User tasks</strong> фиксируют персональные поручения в рамках выбранного задания.</li>
          </ul>
          <p class="muted">Эти связи повторяют структуру БД и помогают быстрее находить нужные сущности.</p>
        </div>
      </div>
    </section>

    <section class="page" data-page="about">
      <div class="card">
        <h2>О нас</h2>
        <p>
          Halomeny — это единая панель управления 3D-печатью, где задачи, операторы и оборудование
          собраны в одном понятном интерфейсе.
        </p>
        <p>
          Мы делаем планирование прозрачным: вы видите загрузку по графику, ближайшие работы и
          приоритетные задания без лишних кликов.
        </p>
        <p class="muted">
          Продукт создан для команд, которым важны скорость согласований, аккуратный контроль сроков и
          уверенность в том, что ресурсы используются по максимуму.
        </p>
      </div>
    </section>

    <section class="page" data-page="profile">
      <div class="layout-grid">
        <div class="card">
          <div class="card__header">
            <h2>Личный кабинет</h2>
            <button class="button button--ghost" id="logout-button" type="button">Выйти</button>
          </div>
          <div id="profile-summary" class="profile-summary">
            <p class="muted">Войдите, чтобы увидеть данные профиля.</p>
          </div>
        </div>
        <div class="card">
          <div class="card__header">
            <h2>Вход</h2>
          </div>
          <form class="form-grid" id="login-form">
            <label>
              Логин
              <input name="login" type="text" autocomplete="username" pattern="[A-Za-z0-9._-]{3,}" required />
            </label>
            <label>
              Пароль
              <input name="password" type="password" autocomplete="current-password" required />
            </label>
            <button class="button" type="submit">Войти</button>
          </form>
        </div>
        <div class="card">
          <div class="card__header">
            <h2>Регистрация</h2>
          </div>
          <form class="form-grid" id="register-form">
            <label>
              Логин
              <input name="login" type="text" autocomplete="username" pattern="[A-Za-z0-9._-]{3,}" required />
            </label>
            <label>
              Email
              <input name="email" type="email" autocomplete="email" required />
            </label>
            <label>
              Пароль
              <input name="password" type="password" autocomplete="new-password" minlength="6" required />
            </label>
            <button class="button" type="submit">Создать аккаунт</button>
          </form>
        </div>
      </div>

      <div class="card" id="admin-panel">
        <div class="card__header">
          <h2>Администрирование пользователей</h2>
        </div>
        <div class="table table--wide" id="users-list"></div>
      </div>
    </section>
  </main>

  <dialog class="modal" id="workspace-modal">
    <form method="dialog" class="modal__content" id="workspace-form">
      <div class="modal__header">
        <h3>Создать рабочее пространство</h3>
        <button class="icon-button" type="button" data-close>✕</button>
      </div>
      <label>
        Название
        <input name="name" type="text" required />
      </label>
      <span class="helper-text">Рабочее пространство привязывает пользователей, оборудование и задания.</span>
      <label>
        Логин пользователя
        <input name="user_login" type="text" pattern="[A-Za-z0-9._-]{3,}" required />
      </label>
      <div class="modal__actions">
        <button class="button" type="submit">Сохранить</button>
      </div>
    </form>
  </dialog>

  <dialog class="modal" id="task-modal">
    <form method="dialog" class="modal__content" id="task-form" data-mode="create">
      <div class="modal__header">
        <h3 id="task-modal-title">Новое задание</h3>
        <button class="icon-button" type="button" data-close>✕</button>
      </div>
      <div class="modal__grid">
        <label>
          Название задания
          <input name="name" type="text" required />
        </label>
        <label>
          Номер документа
          <input name="doc_num" type="text" placeholder="DOC-000" pattern="DOC-\\d{3,6}" required />
        </label>
        <span class="helper-text">Документы связывают задания с планами производства.</span>
        <label>
          Фото модели (URL)
          <input name="photo_url" type="url" placeholder="https://" required />
        </label>
        <label>
          Срок реализации
          <input name="deadline" type="datetime-local" />
        </label>
        <label>
          Оператор
          <select name="operator_id" id="task-operator" required></select>
        </label>
        <label>
          Тип задания
          <select name="device_task_type_id" id="task-type" required></select>
        </label>
        <span class="helper-text">Оператор, тип задания и оборудование связаны через таблицы БД.</span>
        <label>
          Приоритет
          <select name="priority_id" id="task-priority" required></select>
        </label>
        <label>
          Оборудование
          <select name="device_id" id="task-device" required></select>
        </label>
        <label>
          Время выполнения, мин
          <input name="duration_min" type="number" min="0" step="1" required />
        </label>
        <label>
          Время на настройку, мин
          <input name="setup_time_min" type="number" min="0" step="1" required />
        </label>
        <label>
          Время на снятие изделия, мин
          <input name="unload_time_min" type="number" min="0" step="1" required />
        </label>
        <span class="helper-text">Временные параметры используются при расчёте расписания.</span>
        <label>
          Плановое время начала
          <input name="plan_start" type="datetime-local" />
        </label>
        <label>
          Плановое время завершения
          <input name="plan_end" type="datetime-local" />
        </label>
      </div>
      <div class="checkbox-group">
        <label class="checkbox">
          <input type="checkbox" name="need_operator" />
          Требуется участие оператора
        </label>
        <label class="checkbox">
          <input type="checkbox" name="add_in_rec_system" checked />
          Учитывать в рекомендациях
        </label>
      </div>
      <div class="modal__actions">
        <button class="button" type="submit">Сохранить</button>
      </div>
    </form>
  </dialog>

  <dialog class="modal" id="operator-modal">
    <form method="dialog" class="modal__content" id="operator-form" data-mode="create">
      <div class="modal__header">
        <h3 id="operator-modal-title">Новый оператор</h3>
        <button class="icon-button" type="button" data-close>✕</button>
      </div>
      <div class="modal__grid">
        <label>
          ФИО
          <input name="full_name" type="text" required />
        </label>
        <label>
          Номер телефона
          <input name="phone_number" type="tel" inputmode="tel" placeholder="+7 (___) ___-__-__" pattern="\\+7 \\(\\d{3}\\) \\d{3}-\\d{2}-\\d{2}" required />
        </label>
        <label>
          Логин пользователя
          <input name="user_login" type="text" pattern="[A-Za-z0-9._-]{3,}" required />
        </label>
      </div>
      <div class="modal__actions">
        <button class="button" type="submit">Сохранить</button>
      </div>
    </form>
  </dialog>

  <dialog class="modal" id="device-modal">
    <form method="dialog" class="modal__content" id="device-form" data-mode="create">
      <div class="modal__header">
        <h3 id="device-modal-title">Новое оборудование</h3>
        <button class="icon-button" type="button" data-close>✕</button>
      </div>
      <div class="modal__grid">
        <label>
          Название устройства
          <input name="name" type="text" required />
        </label>
        <label>
          Фото устройства (URL)
          <input name="photo_url" type="url" placeholder="https://" required />
        </label>
        <label>
          Тип устройства
          <select name="device_type_id" id="device-type" required></select>
        </label>
        <label>
          Состояние
          <select name="device_state_id" id="device-state" required></select>
        </label>
        <span class="helper-text">Состояние влияет на рекомендации и загрузку.</span>
      </div>
      <label class="checkbox">
        <input type="checkbox" name="add_in_rec_system" checked />
        Учитывать в рекомендациях
      </label>
      <div class="modal__actions">
        <button class="button" type="submit">Сохранить</button>
      </div>
    </form>
  </dialog>

  <dialog class="modal" id="schedule-modal">
    <form method="dialog" class="modal__content" id="schedule-form" data-mode="create">
      <div class="modal__header">
        <h3 id="schedule-modal-title">Новый перерыв</h3>
        <button class="icon-button" type="button" data-close>✕</button>
      </div>
      <div class="modal__grid">
        <label>
          Оператор
          <select name="operator_id" id="schedule-operator" required></select>
        </label>
        <label>
          Тип
          <select name="schedule_type" id="schedule-type" required>
            <option value="lunch">Обед</option>
            <option value="off">Не работает</option>
          </select>
        </label>
        <label>
          Начало
          <input name="start_time" type="datetime-local" required />
        </label>
        <label>
          Завершение
          <input name="end_time" type="datetime-local" required />
        </label>
      </div>
      <div class="modal__actions">
        <button class="button" type="submit">Сохранить</button>
      </div>
    </form>
  </dialog>

  <div class="toast-container" id="toast-container" aria-live="polite"></div>

  <script src="/app.js"></script>
</body>
</html>
